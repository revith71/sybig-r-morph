<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <div class="logo-container" style="text-align: center; width: 100%; margin: 20px 0;">
  <img src="{{ url_for('static', filename='images/logo.png') }}" 
       alt="SyBig-r-Morph Logo" 
       class="logo" 
       style="max-width: 150px; height: auto;">
</div>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyBig-r-Morph</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            padding: 20px;
            font-family: 'Arial', sans-serif;
        }
        .container {
            max-width: 800px;
        }
        .status-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .results-box {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .pseudoword {
            font-size: 18px;
            padding: 5px 10px;
            margin: 5px;
            display: inline-block;
            background-color: #fcbfbb;
            border-radius: 5px;
            border: 1px solid #FF645A;
            cursor: grab; /* Show grab cursor to indicate draggable */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .pseudoword.dragging {
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: grabbing;
            z-index: 100;
        }
        .pseudoword-container {
            min-height: 50px;
            padding: 10px;
        }
        .loading {
            display: none;
            margin-top: 20px;
        }
        .status-message {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .status-time {
            color: #666;
            font-size: 12px;
            margin-right: 8px;
        }
        
        /* Visual indicator for drag-and-drop functionality */
        .reorder-help {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        /* Add space for ordering buttons */
        .word-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .word-actions button {
            margin-left: 5px;
            font-size: 0.8rem;
        }
      
        .status-message:contains("Lexicons loaded successfully"),
        .alert:contains("Lexicons loaded successfully"),
        .status-box .status-message:contains("Lexicons loaded"),
        .status-message.success {
            color: #0f5132 !important; /* Dark green text */
            border-color: #009AB2 !important; 
            font-weight: bold;
            background-color: #e6f7f9 !important; /* Light teal background */
        }
        
        /* Color of warning alert text box */
        .alert-warning, 
        div[class*="warning"],
        div[class*="alert"] {
            color: #fcbfbb !important;
            border-color: #FF645A !important;
            /* Removed duplicate color declaration */
            font-weight: bold !important;
            background-color: #fff0f0 !important;
        }
        
        /* Error message styling */
        .alert-danger,
        .status-message.error,
        .status-message:contains("ERROR:") {
            color: #842029 !important;
            background-color: #f8d7da !important;
            border-color: #f5c2c7 !important;
            font-weight: bold !important;
        }
        
        /* Success alert dark green */
        .status-message.success,
        .alert-success,
        div[class*="success"] {
            color: #037385 !important; 
            border-color: #009AB2 !important;
            font-weight: bold !important;
            background-color: #e6f7f9 !important;
        }
        
        .alert-success,
        .alert.alert-success {
            color: #037385 !important; /* Dark green */
        }
        
        /* Button colors */
        .btn-primary {
            background-color: #009AB2 !important; 
            border-color: #0296ad !important;
            color: white !important;
        }
        .btn-primary:hover, 
        .btn-primary:active,
        .btn-primary:focus,
        .btn-primary.active {
            background-color: #009AB2 !important;
            border-color: #0296ad !important;
            color: white !important;
        }
        
        /* Button colors (CORAL) */
        .btn-success {
            background-color: #FF645A !important; /* Coral */
            border-color: #eb5950 !important;
            color: white !important;
        }
        .btn-success:hover,
        .btn-success:active,
        .btn-success:focus,
        .btn-success.active {
            background-color: #FF645A !important;
            border-color: #eb5950 !important;
            color: white !important;
        }
        
        /* For Webkit browsers (Chrome, Safari) */
        input[type=range]::-webkit-slider-thumb {
          background-color:#FF645A !important; 
          border: 2px solid #eb5950 !important;
        }
        
        /* For Firefox */
        input[type=range]::-moz-range-thumb {
          background-color: #FF645A !important;
          border: 2px solid #eb5950 !important;
        }
        
        /* For IE/Edge */
        input[type=range]::-ms-thumb {
          background-color: #FF645A !important; 
          border: 2px solid #eb5950 !important;
        }
        
        /* Style for the value displays */
        #freq_threshold_value,
        #sim_threshold_value {
          display: inline-block;
          padding: 2px 6px;
          background-color: #fff;
          border: 1px solid #ccc;
          border-radius: 3px;
          font-weight: bold;
          min-width: 30px;
          text-align: center;
        }
        
        /* If you want to match the coral color theme */
        #freq_threshold_value,
        #sim_threshold_value {
          border-color: #FF645A;
          background-color: #fff;
          color: #000;
        }
        
        /* Target only the Copy All and Download CSV buttons */
        .card-header a.btn-outline-light,
        .card-header button.btn-outline-light {
            color: white !important;
            background-color: transparent !important;
            border-color: white !important;
        }
        
        /* Target specific buttons with more precise selectors */
        .btn-copy-all, 
        .copy-all-button,
        .btn-download-csv,
        .download-csv-button,
        #copy-all,
        #download-csv {
            color: white !important;
        }
        
        /* Ensure the text stays white even on hover/focus states */
        .card-header .btn:hover,
        .card-header .btn:active,
        .card-header .btn:focus {
            color: white !important;
        }
        
        /* Target the specific buttons in your card header */
        .card-header .btn {
            color: white !important;
            background-color: transparent !important;
            border-color: white !important;
        }
        
        /* Specifically target buttons by their text content */
        button:contains("CSV"), 
        a:contains("CSV"),
        button:contains("Download CSV"),
        a:contains("Download CSV"),
        button:contains("Copy All"),
        a:contains("Copy All") {
            color: white !important;
            background-color: transparent !important;
            border-color: white !important;
        }
        
        /* Also target likely class names */
        .btn-copy-all, .btn-download-csv {
            color: white !important;
            background-color: transparent !important;
            border-color: white !important;
        }
        
        .card-header {
            background-color: #009AB2 !important;
            color: white !important;
            border-color: #0296ad !important;
        }
        
        /* Alert box for lexicon errors */
        #lexicon-error-alert {
            display: none;
            margin-bottom: 15px;
            padding: 10px 15px;
            color: #842029 !important;
            background-color: #f8d7da !important;
            border: 1px solid #f5c2c7 !important;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">SyBig-r-Morph</h1>
        
        <!-- Lexicon Loading Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Lexicon Status</h5>
            </div>
            <div class="card-body">
                <!-- Error Alert Box -->
                <div id="lexicon-error-alert"></div>
                
                <div id="lexicon-status" class="mb-3">
                    {% if lexicons_loaded %}
                        <div class="alert alert-success">
                            Lexicons loaded successfully
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            Lexicons not loaded. Please click the button below to load lexicons.
                        </div>
                    {% endif %}
                </div>
                <button id="load-lexicons" class="btn btn-primary" {% if lexicons_loaded %}disabled{% endif %}>
                    Load Lexicons
                </button>
            </div>
        </div>
        
        <!-- Generation Parameters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Generation Parameters</h5>
            </div>
            <div class="card-body">
                <form id="generation-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="postype" class="form-label">Part of Speech:</label>
                            <select id="postype" name="postype" class="form-select" {% if not lexicons_loaded %}disabled{% endif %}>
                                {% if lexicons_loaded %}
                                    <option value="all">All</option>
                                    {% set allowed_pos = ["noun", "verb", "adj", "adv", "prep"] %}
                                    {% for pos in available_pos %}
                                        {% if pos in allowed_pos %}
                                            {% set display_name = {
                                                "noun": "Noun", 
                                                "verb": "Verb", 
                                                "adj": "Adjective", 
                                                "adv": "Adverb", 
                                                "prep": "Preposition"
                                            }.get(pos, pos) %}
                                            <option value="{{ pos }}">{{ display_name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="num_syllables" class="form-label">Number of Syllables:</label>
                            <select id="num_syllables" name="num_syllables" class="form-select">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="freq_threshold" class="form-label">Frequency Threshold:</label>
                            <input type="range" class="form-range" id="freq_threshold" name="freq_threshold" 
                                min="1.327 " max="7.533" step="0.1" value="3.5">
                            <div class="d-flex justify-content-between">
                                <small>1.327</small>
                                <small id="freq_threshold_value">5.0</small>
                                <small>7.533</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="sim_threshold" class="form-label">Similarity Threshold:</label>
                            <input type="range" class="form-range" id="sim_threshold" name="sim_threshold" 
                                min="0.0" max="1.0" step="0.1" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small>0.0</small>
                                <small id="sim_threshold_value">0.8</small>
                                <small>1.0</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="max_words" class="form-label">Number of Words:</label>
                        <input type="number" class="form-control" id="max_words" name="max_words" 
                            min="1" max="1000" value="20">
                    </div>
                    
                    <button type="submit" class="btn btn-success" id="generate-btn" {% if not lexicons_loaded %}disabled{% endif %}>
                        Generate Pseudowords
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div class="loading text-center" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating pseudowords... This may take a moment.</p>
        </div>
        
        <!-- Status and Results -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Status</h5>
            </div>
            <div class="card-body">
                <div class="status-box" id="status-box"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Generated Pseudowords</h5>
                <div>
                    <button id="sort-alpha-btn" class="btn btn-sm btn-outline-light" disabled>
                        Sort A-Z
                    </button>
                    <button id="sort-random-btn" class="btn btn-sm btn-outline-light" disabled>
                        Randomize
                    </button>
                    <button id="copy-btn" class="btn btn-sm btn-outline-light" disabled>
                        Copy All
                    </button>
                    <button id="download-csv-btn" class="btn btn-sm btn-outline-light ms-2" disabled>
                        Download CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="word-controls">
                    <div class="reorder-help">
                        <i class="bi bi-info-circle"></i> Drag and drop words to reorder them.
                    </div>
                </div>
                <div class="results-box" id="results-box">
                    <div class="pseudoword-container" id="pseudoword-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const loadLexiconsBtn = document.getElementById('load-lexicons');
            const generateForm = document.getElementById('generation-form');
            const generateBtn = document.getElementById('generate-btn');
            const statusBox = document.getElementById('status-box');
            const resultsBox = document.getElementById('results-box');
            const pseudowordContainer = document.getElementById('pseudoword-container');
            const loading = document.getElementById('loading');
            const copyBtn = document.getElementById('copy-btn');
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            const sortAlphaBtn = document.getElementById('sort-alpha-btn');
            const sortRandomBtn = document.getElementById('sort-random-btn');
            const freqThreshold = document.getElementById('freq_threshold');
            const freqThresholdValue = document.getElementById('freq_threshold_value');
            const simThreshold = document.getElementById('sim_threshold');
            const simThresholdValue = document.getElementById('sim_threshold_value');
            const lexiconErrorAlert = document.getElementById('lexicon-error-alert');
            
            // Drag and drop functionality
            let draggedItem = null;
            
            function addDragListeners(element) {
                element.setAttribute('draggable', 'true');
                
                element.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => this.classList.add('dragging'), 0);
                    
                    // Set data for drag operation
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.textContent);
                });
                
                element.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                });
            }
            
            // Setup the pseudoword container for drop events
            pseudowordContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElement(this, e.clientY);
                
                if (draggedItem) {
                    if (afterElement) {
                        this.insertBefore(draggedItem, afterElement);
                    } else {
                        this.appendChild(draggedItem);
                    }
                }
            });
            
            pseudowordContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                // The actual movement is handled in dragover
                addStatusMessage("Word order updated");
            });
            
            // Determine where to insert the dragged element
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.pseudoword:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // Update range value displays
            freqThreshold.addEventListener('input', function() {
                freqThresholdValue.textContent = this.value;
            });
            
            simThreshold.addEventListener('input', function() {
                simThresholdValue.textContent = this.value;
            });
            
            // Load Lexicons
            loadLexiconsBtn.addEventListener('click', function() {
                loadLexiconsBtn.disabled = true;
                statusBox.innerHTML = '<div class="status-message"><span class="status-time">' + 
                    getCurrentTime() + '</span>Loading lexicons, please wait...</div>';
                
                // Hide any previous error message
                lexiconErrorAlert.style.display = 'none';
                lexiconErrorAlert.textContent = '';
                
                fetch('/load_lexicons', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('lexicon-status').innerHTML =
                            '<div class="alert alert-success">Lexicons loaded successfully</div>';
                                
                        // Update part of speech dropdown
                        const posSelect = document.getElementById('postype');
                        posSelect.innerHTML = '';
                        
                        // Create a mapping of original values to display names
                        const posMapping = {
                            "noun": "Noun",
                            "verb": "Verb",
                            "adj": "Adjective",
                            "adv": "Adverb",
                            "prep": "Preposition"
                        };
                        
                        // Define which POS to include (only these five)
                        const includedPos = ["noun", "verb", "adj", "adv", "prep"];
                        
                        // Filter and sort the available_pos array to only include our desired parts of speech
                        const filteredPos = data.available_pos.filter(pos => includedPos.includes(pos))
                            .sort((a, b) => {
                                return includedPos.indexOf(a) - includedPos.indexOf(b);
                            });
                        
                        // Add "All" option at the top
                        const allOption = document.createElement('option');
                        allOption.value = "all";
                        allOption.textContent = "All";
                        posSelect.appendChild(allOption);
                        
                        // Add the filtered options to the dropdown
                        filteredPos.forEach(pos => {
                            const option = document.createElement('option');
                            option.value = pos; // Keep original value for backend processing
                            option.textContent = posMapping[pos]; // Use mapped name
                            posSelect.appendChild(option);
                        });
                            
                        posSelect.disabled = false;
                        generateBtn.disabled = false;
                        addStatusMessage('Lexicons loaded successfully', 'success');
                    } else {
                        // Show error message
                        document.getElementById('lexicon-status').innerHTML = 
                            '<div class="alert alert-danger">Error loading lexicons</div>';
                            
                        // Display error in the error alert box
                        lexiconErrorAlert.textContent = data.message;
                        lexiconErrorAlert.style.display = 'block';
                            
                        loadLexiconsBtn.disabled = false;
                        addStatusMessage('Error loading lexicons: ' + data.message, 'error');
                        
                        // Update status messages if they were returned
                        if (data.status && data.status.length > 0) {
                            updateStatus(data.status);
                        }
                    }
                })
                .catch(error => {
                    document.getElementById('lexicon-status').innerHTML = 
                        '<div class="alert alert-danger">Error loading lexicons: ' + error.message + '</div>';
                    loadLexiconsBtn.disabled = false;
                    addStatusMessage('Error loading lexicons: ' + error.message, 'error');
                });
            });
            
            // Generate Pseudowords
            generateForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Clear previous results
                pseudowordContainer.innerHTML = '';
                copyBtn.disabled = true;
                downloadCsvBtn.disabled = true;
                sortAlphaBtn.disabled = true;
                sortRandomBtn.disabled = true;
                
                // Show loading indicator
                loading.style.display = 'block';
                generateBtn.disabled = true;
                
                // Get form data
                const formData = new FormData(generateForm);
                
                // Send request
                fetch('/generate', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    loading.style.display = 'none';
                    generateBtn.disabled = false;
                    
                    // Update status
                    updateStatus(data.status);
                    
                    if (data.success) {
                        // Display results
                        if (data.pseudowords && data.pseudowords.length > 0) {
                            data.pseudowords.forEach((word, index) => {
                                const wordElement = document.createElement('div');
                                wordElement.className = 'pseudoword';
                                wordElement.textContent = word;
                                pseudowordContainer.appendChild(wordElement);
                                
                                // Add drag functionality
                                addDragListeners(wordElement);
                            });
                            
                            // Enable buttons
                            copyBtn.disabled = false;
                            downloadCsvBtn.disabled = false;
                            sortAlphaBtn.disabled = false;
                            sortRandomBtn.disabled = false;
                        } else {
                            pseudowordContainer.innerHTML = '<p>No pseudowords were generated. Try adjusting parameters.</p>';
                        }
                    } else {
                        // Show error message
                        addStatusMessage('Error: ' + data.message, 'error');
                        
                        // Display in error alert if it's a lexicon-related error
                        if (data.message.includes('lexicon') || data.message.includes('Lexicon')) {
                            lexiconErrorAlert.textContent = data.message;
                            lexiconErrorAlert.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    // Hide loading indicator
                    loading.style.display = 'none';
                    generateBtn.disabled = false;
                    
                    // Show error
                    addStatusMessage('Error: ' + error.message, 'error');
                });
            });
            
            // Sort alphabetically
            sortAlphaBtn.addEventListener('click', function() {
                const words = Array.from(document.querySelectorAll('#pseudoword-container .pseudoword'));
                
                // Sort words alphabetically
                words.sort((a, b) => a.textContent.localeCompare(b.textContent));
                
                // Clear container
                pseudowordContainer.innerHTML = '';
                
                // Add words back in sorted order
                words.forEach(word => {
                    pseudowordContainer.appendChild(word);
                });
                
                addStatusMessage('Pseudowords sorted alphabetically');
            });
            
            // Randomize order
            sortRandomBtn.addEventListener('click', function() {
                const words = Array.from(document.querySelectorAll('#pseudoword-container .pseudoword'));
                
                // Fisher-Yates shuffle algorithm
                for (let i = words.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    pseudowordContainer.insertBefore(words[j], words[i]);
                }
                
                addStatusMessage('Pseudowords randomly reordered');
            });
            
            // Copy all pseudowords
            copyBtn.addEventListener('click', function() {
                const pseudowords = Array.from(document.querySelectorAll('#pseudoword-container .pseudoword'))
                    .map(el => el.textContent)
                    .join('\n');
                
                navigator.clipboard.writeText(pseudowords).then(function() {
                    // Success
                    addStatusMessage('Copied all pseudowords to clipboard in current order');
                }, function() {
                    // Failure
                    addStatusMessage('Failed to copy pseudowords to clipboard', 'error');
                });
            });
            
            // Download CSV functionality
            downloadCsvBtn.addEventListener('click', function() {
                // Show loading
                loading.style.display = 'block';
                addStatusMessage('Preparing CSV download...');
                
                // Hide any previous error messages
                lexiconErrorAlert.style.display = 'none';
                
                // Get form data
                const formData = new FormData(generateForm);
                
                // Add current word order as a JSON string
                const currentWords = Array.from(document.querySelectorAll('#pseudoword-container .pseudoword'))
                    .map(el => el.textContent);
                
                // Create a form submission for downloading with ordered words
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/download_csv';
                
                // Add all form fields
                for (const [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }
                
                // Add the current words as a hidden field
                const wordsInput = document.createElement('input');
                wordsInput.type = 'hidden';
                wordsInput.name = 'ordered_words';
                wordsInput.value = JSON.stringify(currentWords);
                form.appendChild(wordsInput);
                
                // Add to document, submit, and remove
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                // Hide loading after a delay
                setTimeout(() => {
                    loading.style.display = 'none';
                    addStatusMessage('CSV download initiated with current word order');
                }, 1000);
            });
            
            // Helper functions
            function getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString();
            }
            
            function addStatusMessage(message, type = '') {
                const messageElement = document.createElement('div');
                messageElement.className = 'status-message';
                
                // Add type class if specified
                if (type) {
                    messageElement.classList.add(type);
                }
                
                // Make error messages more visible
                if (type === 'error' || message.includes('ERROR:') || message.includes('Error:')) {
                    messageElement.classList.add('error');
                }
                
                // Add success class for success messages
                if (type === 'success' || message.includes('successfully')) {
                    messageElement.classList.add('success');
                }
                
                messageElement.innerHTML = '<span class="status-time">' + getCurrentTime() + '</span>' + message;
                statusBox.appendChild(messageElement);
                statusBox.scrollTop = statusBox.scrollHeight;
            }
            
            function updateStatus(statusMessages) {
                if (statusMessages && statusMessages.length > 0) {
                    statusMessages.forEach(status => {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'status-message';
                        
// Add error class for error messages
                        if (status.message.includes('ERROR:') || status.message.includes('Error:')) {
                            messageElement.classList.add('error');
                        }
                        
                        // Add success class for success messages
                        if (status.message.includes('success') || status.message.includes('Successfully')) {
                            messageElement.classList.add('success');
                        }
                        
                        messageElement.innerHTML = '<span class="status-time">' + status.time + '</span>' + status.message;
                        statusBox.appendChild(messageElement);
                    });
                    
                    // Scroll to the bottom
                    statusBox.scrollTop = statusBox.scrollHeight;
                }
            }
            
            // Add error listener for CSV download errors
            window.addEventListener('error', function(event) {
                if (event.target.tagName === 'FORM' && event.target.action.includes('/download_csv')) {
                    loading.style.display = 'none';
                    addStatusMessage('Error downloading CSV file. Please make sure lexicons are loaded.', 'error');
                }
            }, true);
        });
    </script>
</body>
</html>